{"version":3,"sources":["../../../../../src/streaming/protection/Protection.js"],"names":[],"mappings":"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","file":"Protection.js","sourcesContent":["/**\n * The copyright in this software is being made available under the BSD License,\n * included below. This software may be subject to other third party and contributor\n * rights, including patent rights, and no such rights are granted under this license.\n *\n * Copyright (c) 2013, Dash Industry Forum.\n * All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without modification,\n * are permitted provided that the following conditions are met:\n *  * Redistributions of source code must retain the above copyright notice, this\n *  list of conditions and the following disclaimer.\n *  * Redistributions in binary form must reproduce the above copyright notice,\n *  this list of conditions and the following disclaimer in the documentation and/or\n *  other materials provided with the distribution.\n *  * Neither the name of Dash Industry Forum nor the names of its\n *  contributors may be used to endorse or promote products derived from this software\n *  without specific prior written permission.\n *\n *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS AND ANY\n *  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.\n *  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,\n *  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT\n *  NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n *  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,\n *  WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)\n *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE\n *  POSSIBILITY OF SUCH DAMAGE.\n */\nimport ProtectionController from './controllers/ProtectionController';\nimport ProtectionKeyController from './controllers/ProtectionKeyController';\nimport ProtectionEvents from './ProtectionEvents';\nimport ProtectionModel_21Jan2015 from './models/ProtectionModel_21Jan2015';\nimport ProtectionModel_3Feb2014 from './models/ProtectionModel_3Feb2014';\nimport ProtectionModel_01b from './models/ProtectionModel_01b';\n\nconst APIS_ProtectionModel_01b = [\n    // Un-prefixed as per spec\n    {\n        // Video Element\n        generateKeyRequest: 'generateKeyRequest',\n        addKey: 'addKey',\n        cancelKeyRequest: 'cancelKeyRequest',\n\n        // Events\n        needkey: 'needkey',\n        keyerror: 'keyerror',\n        keyadded: 'keyadded',\n        keymessage: 'keymessage'\n    },\n    // Webkit-prefixed (early Chrome versions and Chrome with EME disabled in chrome://flags)\n    {\n        // Video Element\n        generateKeyRequest: 'webkitGenerateKeyRequest',\n        addKey: 'webkitAddKey',\n        cancelKeyRequest: 'webkitCancelKeyRequest',\n\n        // Events\n        needkey: 'webkitneedkey',\n        keyerror: 'webkitkeyerror',\n        keyadded: 'webkitkeyadded',\n        keymessage: 'webkitkeymessage'\n    }\n];\n\nconst APIS_ProtectionModel_3Feb2014 = [\n    // Un-prefixed as per spec\n    // Chrome 38-39 (and some earlier versions) with chrome://flags -- Enable Encrypted Media Extensions\n    {\n        // Video Element\n        setMediaKeys: 'setMediaKeys',\n        // MediaKeys\n        MediaKeys: 'MediaKeys',\n        // MediaKeySession\n        release: 'close',\n\n        // Events\n        needkey: 'needkey',\n        error: 'keyerror',\n        message: 'keymessage',\n        ready: 'keyadded',\n        close: 'keyclose'\n    },\n    // MS-prefixed (IE11, Windows 8.1)\n    {\n        // Video Element\n        setMediaKeys: 'msSetMediaKeys',\n        // MediaKeys\n        MediaKeys: 'MSMediaKeys',\n        // MediaKeySession\n        release: 'close',\n        // Events\n        needkey: 'msneedkey',\n        error: 'mskeyerror',\n        message: 'mskeymessage',\n        ready: 'mskeyadded',\n        close: 'mskeyclose'\n    }\n];\n\nfunction Protection() {\n    let instance;\n    const context = this.context;\n\n    /**\n     * Create a ProtectionController and associated ProtectionModel for use with\n     * a single piece of content.\n     *\n     * @param {Object} config\n     * @return {ProtectionController} protection controller\n     *\n     */\n    function createProtectionSystem(config) {\n        let controller = null;\n\n        const protectionKeyController = ProtectionKeyController(context).getInstance();\n        protectionKeyController.setConfig({ debug: config.debug, BASE64: config.BASE64 });\n        protectionKeyController.initialize();\n\n        let protectionModel =  getProtectionModel(config);\n\n        if (!controller && protectionModel) {//TODO add ability to set external controller if still needed at all?\n            controller = ProtectionController(context).create({\n                protectionModel: protectionModel,\n                protectionKeyController: protectionKeyController,\n                eventBus: config.eventBus,\n                debug: config.debug,\n                events: config.events,\n                BASE64: config.BASE64,\n                constants: config.constants\n            });\n            config.capabilities.setEncryptedMediaSupported(true);\n        }\n        return controller;\n    }\n\n    function getProtectionModel(config) {\n        const debug = config.debug;\n        const logger = debug.getLogger(instance);\n        const eventBus = config.eventBus;\n        const errHandler = config.errHandler;\n        const videoElement = config.videoModel ? config.videoModel.getElement() : null;\n\n        if ((!videoElement || videoElement.onencrypted !== undefined) &&\n            (!videoElement || videoElement.mediaKeys !== undefined)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_21Jan2015)');\n            return ProtectionModel_21Jan2015(context).create({ debug: debug, eventBus: eventBus, events: config.events });\n        } else if (getAPI(videoElement, APIS_ProtectionModel_3Feb2014)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_3Feb2014)');\n            return ProtectionModel_3Feb2014(context).create({ debug: debug, eventBus: eventBus, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_3Feb2014) });\n        } else if (getAPI(videoElement, APIS_ProtectionModel_01b)) {\n            logger.info('EME detected on this user agent! (ProtectionModel_01b)');\n            return ProtectionModel_01b(context).create({ debug: debug, eventBus: eventBus, errHandler: errHandler, events: config.events, api: getAPI(videoElement, APIS_ProtectionModel_01b) });\n        } else {\n            logger.warn('No supported version of EME detected on this user agent! - Attempts to play encrypted content will fail!');\n            return null;\n        }\n    }\n\n    function getAPI(videoElement, apis) {\n        for (let i = 0; i < apis.length; i++) {\n            const api = apis[i];\n            // detect if api is supported by browser\n            // check only first function in api -> should be fine\n            if (typeof videoElement[api[Object.keys(api)[0]]] !== 'function') {\n                continue;\n            }\n\n            return api;\n        }\n\n        return null;\n    }\n\n    instance = {\n        createProtectionSystem: createProtectionSystem\n    };\n\n    return instance;\n}\n\nProtection.__dashjs_factory_name = 'Protection';\nconst factory = dashjs.FactoryMaker.getClassFactory(Protection); /* jshint ignore:line */\nfactory.events = ProtectionEvents;\ndashjs.FactoryMaker.updateClassFactory(Protection.__dashjs_factory_name, factory); /* jshint ignore:line */\nexport default factory;\n"]}