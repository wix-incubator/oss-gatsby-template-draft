{"version":3,"sources":["../../../../../../src/streaming/rules/abr/SwitchHistoryRule.js"],"names":[],"mappings":"2LACyB,4BAA4B,0FACnC,qBAAqB,gFACb,kBAAkB,6DAE5C,SAAS,iBAAiB,EAAG,CAEzB,IAAM,OAAO,CAAG,IAAI,CAAC,OAAO,CAAC,AAE7B,IAAI,QAAQ,UAAA,CACR,MAAM,UAAA,CAAC;AAGX,IAAM,UAAU,CAAG,KAAK,CAAC;;AAIzB,IAAM,WAAW,CAAG,CAAC,CAAC,AAEtB,SAAS,KAAK,EAAG,CACb,MAAM,GAAG,2BAAM,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC,CAC7D,AAED,SAAS,WAAW,CAAC,YAAY,CAAE,CAC/B,IAAM,oBAAoB,CAAG,YAAY,CAAG,YAAY,CAAC,gBAAgB,EAAE,CAAG,IAAI,CAAC,AACnF,IAAM,cAAc,CAAG,oBAAoB,CAAG,oBAAoB,CAAC,iBAAiB,EAAE,CAAG,EAAE,CAAC,AAC5F,IAAI,KAAK,CAAG,CAAC,CAAC,AACd,IAAI,OAAO,CAAG,CAAC,CAAC,AAChB,IAAI,QAAQ,CAAG,CAAC,CAAC,AACjB,IAAM,aAAa,CAAG,+BAAc,OAAO,CAAC,CAAC,MAAM,EAAE,CAAC,AAEtD,IAAK,IAAI,CAAC,CAAG,CAAC,CAAE,CAAC,GAAG,cAAc,CAAC,MAAM,CAAE,CAAC,EAAE,EAAE,CAC5C,GAAI,cAAc,CAAC,CAAC,CAAC,KAAK,SAAS,CAAE,CACjC,KAAK,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,AACjC,OAAO,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,AACrC,QAAQ,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,AAEvC,GAAI,KAAK,GAAG,OAAO,IAAI,WAAW,IAAK,KAAK,GAAG,OAAO,GAAG,UAAU,AAAC,CAAE,CAClE,aAAa,CAAC,OAAO,GAAG,AAAC,CAAC,GAAG,CAAC,IAAI,cAAc,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAI,CAAC,GAAG,CAAC,CAAG,CAAC,CAAC,AAC3E,aAAa,CAAC,MAAM,GAAG,CAAC,KAAK,CAAE,aAAa,CAAC,OAAO,CAAE,KAAK,CAAE,KAAK,CAAE,OAAO,CAAE,OAAO,CAAE,QAAQ,CAAE,QAAQ,CAAC,CAAC,AAC1G,MAAM,CAAC,IAAI,CAAC,6BAA6B,GAAG,aAAa,CAAC,OAAO,GAAG,YAAY,IAAI,KAAK,GAAG,OAAO,CAAA,AAAC,GAAG,UAAU,GAAG,KAAK,CAAC,CAAC,AAC3H,MAAM,CACT,CACJ,CACJ,AAED,OAAO,aAAa,CAAC,CACxB,AAED,QAAQ,GAAG,CACP,WAAW,CAAE,WAAW,CAC3B,CAAC,AAEF,KAAK,EAAE,CAAC,AAER,OAAO,QAAQ,CAAC,CACnB,AAGD,iBAAiB,CAAC,qBAAqB,GAAG,mBAAmB,CAAC,qBAC/C,8BAAa,eAAe,CAAC,iBAAiB,CAAC","file":"SwitchHistoryRule.js","sourcesContent":["\nimport FactoryMaker from '../../../core/FactoryMaker';\nimport Debug from '../../../core/Debug';\nimport SwitchRequest from '../SwitchRequest';\n\nfunction SwitchHistoryRule() {\n\n    const context = this.context;\n\n    let instance,\n        logger;\n\n    //MAX_SWITCH is the number of drops made. It doesn't consider the size of the drop.\n    const MAX_SWITCH = 0.075;\n\n    //Before this number of switch requests(no switch or actual), don't apply the rule.\n    //must be < SwitchRequestHistory SWITCH_REQUEST_HISTORY_DEPTH to enable rule\n    const SAMPLE_SIZE = 6;\n\n    function setup() {\n        logger = Debug(context).getInstance().getLogger(instance);\n    }\n\n    function getMaxIndex(rulesContext) {\n        const switchRequestHistory = rulesContext ? rulesContext.getSwitchHistory() : null;\n        const switchRequests = switchRequestHistory ? switchRequestHistory.getSwitchRequests() : [];\n        let drops = 0;\n        let noDrops = 0;\n        let dropSize = 0;\n        const switchRequest = SwitchRequest(context).create();\n\n        for (let i = 0; i < switchRequests.length; i++) {\n            if (switchRequests[i] !== undefined) {\n                drops += switchRequests[i].drops;\n                noDrops += switchRequests[i].noDrops;\n                dropSize += switchRequests[i].dropSize;\n\n                if (drops + noDrops >= SAMPLE_SIZE && (drops / noDrops > MAX_SWITCH)) {\n                    switchRequest.quality = (i > 0 && switchRequests[i].drops > 0) ? i - 1 : i;\n                    switchRequest.reason = {index: switchRequest.quality, drops: drops, noDrops: noDrops, dropSize: dropSize};\n                    logger.info('Switch history rule index: ' + switchRequest.quality + ' samples: ' + (drops + noDrops) + ' drops: ' + drops);\n                    break;\n                }\n            }\n        }\n\n        return switchRequest;\n    }\n\n    instance = {\n        getMaxIndex: getMaxIndex\n    };\n\n    setup();\n\n    return instance;\n}\n\n\nSwitchHistoryRule.__dashjs_factory_name = 'SwitchHistoryRule';\nexport default FactoryMaker.getClassFactory(SwitchHistoryRule);\n"]}