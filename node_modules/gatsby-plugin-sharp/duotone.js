"use strict";

var _asyncToGenerator2 = require("babel-runtime/helpers/asyncToGenerator");

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var sharp = require("sharp");

module.exports = function () {
  var _ref = (0, _asyncToGenerator3.default)(regeneratorRuntime.mark(function _callee(duotone, format, clonedPipeline) {
    var duotoneGradient;
    return regeneratorRuntime.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            duotoneGradient = createDuotoneGradient(hexToRgb(duotone.highlight), hexToRgb(duotone.shadow));

            // @todo remove once we upgrade to sharp v0.18 which
            // adds an alias for "jpg" to toFormat
            // @see http://sharp.dimens.io/en/stable/changelog/#v0180-30th-may-2017

            if (format === "jpg") {
              format = "jpeg";
            }

            _context.next = 4;
            return clonedPipeline.raw().toBuffer({ resolveWithObject: true }).then(function (_ref2) {
              var data = _ref2.data,
                  info = _ref2.info;

              for (var i = 0; i < data.length; i = i + info.channels) {
                var r = data[i + 0];
                var g = data[i + 1];
                var b = data[i + 2];

                // @see https://en.wikipedia.org/wiki/Relative_luminance
                var avg = Math.round(0.2126 * r + 0.7152 * g + 0.0722 * b);

                data[i + 0] = duotoneGradient[avg][0];
                data[i + 1] = duotoneGradient[avg][1];
                data[i + 2] = duotoneGradient[avg][2];
              }

              return sharp(data, {
                raw: info
              }).toFormat(format);
            });

          case 4:
            return _context.abrupt("return", _context.sent);

          case 5:
          case "end":
            return _context.stop();
        }
      }
    }, _callee, this);
  }));

  function duotone(_x, _x2, _x3) {
    return _ref.apply(this, arguments);
  }

  return duotone;
}();

// @see https://github.com/nagelflorian/react-duotone/blob/master/src/hex-to-rgb.js
function hexToRgb(hex) {
  var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
}

// @see https://github.com/nagelflorian/react-duotone/blob/master/src/create-duotone-gradient.js
function createDuotoneGradient(primaryColorRGB, secondaryColorRGB) {
  var duotoneGradient = [];

  for (var i = 0; i < 256; i++) {
    var ratio = i / 255;
    duotoneGradient.push([Math.round(primaryColorRGB[0] * ratio + secondaryColorRGB[0] * (1 - ratio)), Math.round(primaryColorRGB[1] * ratio + secondaryColorRGB[1] * (1 - ratio)), Math.round(primaryColorRGB[2] * ratio + secondaryColorRGB[2] * (1 - ratio))]);
  }

  return duotoneGradient;
}